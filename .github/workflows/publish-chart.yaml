name: üóûÔ∏è Publish Helm Chart

on:
  workflow_dispatch:
  # push:
  #   branches: [ main ]

jobs:
  publish:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set up Helm
      uses: azure/setup-helm@v1

    - name: Login to GitHub Container Registry
      run: helm registry login ghcr.io -u ${{ github.actor }} --password ${{ secrets.GITHUB_TOKEN }}

    - name: Package and Save Chart
      run: |
        helm package -d charts/oblik .
        helm package -d charts/vpa .
        helm chart save . ghcr.io/${{ github.repository_owner }}/${{ github.event.repository.name }}/mychart:0.1.0
        helm chart push ghcr.io/${{ github.repository_owner }}/${{ github.event.repository.name }}/mychart:0.1.0

    - name: Generate Helm Index
      run: |
        mkdir -p gh-pages
        cp charts/*.tgz gh-pages/
        helm repo index gh-pages --url https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}
        
    - name: Deploy to GitHub Pages
      uses: peaceiris/actions-gh-pages@v3
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        publish_dir: gh-pages
